# AvatarAssembler処理フロー

```mermaid
flowchart TB

start([CreateAssembledAvatar])
--> id1["baseModelをコピー"]
--> id2["baseModelの位置・名前を修正"]
--> id3[["CopyAvatarParts"]]
--> stop([stop])
```

```mermaid
flowchart TB
start(["CopyAvatarParts"])
--> id1["パーツのルートボーンを取得"]
--> id2[["CreateBonePathList"]]
--> id3[/"パーツ毎に繰り返し"\]
--> id4["パーツから、結合モデルのルートボーンと\n同じ名前のオブジェクトをルートとして取得"]
--> id5["パーツのルート以下のリストを取得"]
--> id6[/"パーツのオブジェクト毎に繰り返し"\]
--> id7{{"結合モデルに同じオブジェクトが存在する"}}
id7 -- yes --> id8["コンポーネントリマッパーを追加"]
id7 -- no --> id9{{"親が結合モデルに存在するか確認"}}
id9 -- yes --> id10["パーツオブジェクトを追加"]
--> id11["子を削除"]
--> id12["再生成するコンポーネントを削除"]
--> id13["元オブジェクトのローカルトランスフォームに揃える"]
--> id14["結合モデルのリストに追加したオブジェクトを加える"]
--> id15["コンポーネントリマッパーを追加"]
id9 -- no --> id16["エラー表示"]
id17[\"オブジェクト毎の繰り返し終端"/]
id8 --> id17
id15 --> id17
id16 --> id17
id17 --> id18["コンポーネントをリマップ"]
--> id19["リマッパーをクリア"]
--> id20["メッシュをコピー(CopyMesh)"]
--> id21["アンカーオーバーライドを書き換え"]
--> id22[\"パーツ毎の繰り返し終端"/]
--> stop([stop])
```

```mermaid
flowchart TB
start(["CopyMesh"])
--> id1["パーツに含まれるSkinnedMeshRendererを取得"]
--> id2[/"メッシュ毎に繰り返し"\]
--> id3["メッシュのオブジェクトをInstantiate"]
--> id4["名前を合わせる"]
--> id5["追加メッシュオブジェクを結合オブジェクトの下に置く"]
--> id6["ローカルトランスポーズを合わせる。"]
--> id7["共有メッシュを取得"]
--> id8[["ボーンリストを更新"]]
--> id9["ルートボーンの参照切り替え"]
--> id10[["Clothコンポーネントの参照書き換え"]]
--> id11["AnchorOverrideの情報を取得"]
--> id12["skinnedMeshRendererとprobeAnchorのパスをリストに追加"]
--> id13[\"メッシュ毎の繰り返し終端"/]
--> stop([stop])
```


```mermaid
flowchart TB
start(["ボーンリストを更新"])
--> id1[/"元のボーンリストについて繰り返し"\]
--> id2["パーツ配下のボーンパスを取得"]
--> id3["結合オブジェクトから同じパスのボーンを取得\n(見つからなければエラー)"]
--> id4["ボーンリストに追加"]
--> id5[\ボーン毎の繰り返し終端/]
--> id6["ボーンリストを差し替え"]
--> stop([stop])